<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil Ciudadano: {{ citizen.first_name }} {{ citizen.last_name }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .profile-header {
            background: linear-gradient(135deg, #2c3e50, #4ca1af);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        .profile-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .section-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .dni-card {
            max-width: 300px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <!-- Header / Navbar simple -->
    <nav class="navbar navbar-dark bg-dark mb-0">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.official_dashboard') }}">‚Üê Volver al Panel Oficial</a>
            <span class="navbar-text">
                Logueado como: {{ current_user.first_name }} {{ current_user.last_name }} ({{ current_user.department }})
            </span>
        </div>
    </nav>

    <!-- Profile Header -->
    <div class="profile-header text-center">
        <div class="container">
            <!-- CORRECCI√ìN: Cambiado 'uploads/' a 'img/' para coincidir con la carpeta de guardado -->
            <img src="{{ url_for('static', filename='img/' + citizen.selfie_filename) }}" alt="Foto Perfil" class="profile-img mb-3">
            <h1>{{ citizen.first_name }} {{ citizen.last_name }}</h1>
            <p class="lead">DNI: {{ citizen.dni }}</p>
            {% if citizen.discord_id %}
                <span class="badge bg-primary">Discord Vinculado</span>
            {% else %}
                <span class="badge bg-secondary">Sin Discord</span>
            {% endif %}
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- Left Column: Personal Info & Bank -->
            <div class="col-md-4">
                <div class="section-card">
                    <h4>Datos Personales</h4>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Nombre:</strong> {{ citizen.first_name }}</li>
                        <li class="list-group-item"><strong>Apellido:</strong> {{ citizen.last_name }}</li>
                        <li class="list-group-item"><strong>DNI:</strong> {{ citizen.dni }}</li>
                        <li class="list-group-item"><strong>Estado:</strong> Ciudadano</li>
                    </ul>
                    <div class="mt-3 text-center">
                        <label class="form-label text-muted">Foto DNI:</label><br>
                        <!-- CORRECCI√ìN: Cambiado 'uploads/' a 'img/' -->
                        <img src="{{ url_for('static', filename='img/' + citizen.dni_photo_filename) }}" class="dni-card img-fluid" alt="DNI Foto">
                    </div>
                </div>

                <div class="section-card">
                    <h4>Informaci√≥n Bancaria</h4>
                    {% if citizen.bank_account %}
                        <p><strong>Cuenta:</strong> {{ citizen.bank_account.account_number }}</p>
                        <h3 class="text-success">${{ "{:,.2f}".format(citizen.bank_account.balance) }}</h3>
                    {% else %}
                        <p class="text-muted">Este ciudadano no tiene cuenta bancaria.</p>
                    {% endif %}
                </div>

                <!-- Licencias -->
                <div class="section-card">
                    <h4>Licencias</h4>
                    {% if citizen.licenses %}
                        <ul class="list-group">
                        {% for lic in citizen.licenses %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ lic.type }}
                                <span class="badge bg-{{ 'success' if lic.status == 'Activa' else 'danger' }}">{{ lic.status }}</span>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No posee licencias.</p>
                    {% endif %}
                </div>

                <!-- Notas / Comentarios -->
                <div class="section-card">
                    <h4>Notas Oficiales</h4>
                    {% if citizen.comments %}
                        <div style="max-height: 200px; overflow-y: auto;" class="mb-3">
                            {% for comment in citizen.comments %}
                                <div class="border-bottom pb-2 mb-2">
                                    <small class="text-muted">{{ comment.created_at.strftime('%d/%m/%Y') }} - {{ comment.author.first_name }} {{ comment.author.last_name }} ({{ comment.author.department }})</small>
                                    <p class="mb-0">{{ comment.content }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted small">Sin comentarios.</p>
                    {% endif %}

                    {% if can_edit %}
                    <form action="{{ url_for('main.add_comment', user_id=citizen.id) }}" method="POST">
                        {{ comment_form.hidden_tag() }}
                        <div class="input-group">
                            {{ comment_form.content(class="form-control", placeholder="Agregar nota...", rows=1) }}
                            <button class="btn btn-outline-secondary" type="submit">Add</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>

            <!-- Right Column: Actions & Records -->
            <div class="col-md-8">
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category if category != 'message' else 'info' }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Panel de Control Financiero (Solo Gobierno) -->
                {% if can_adjust_balance %}
                <div class="card mb-4 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Control Financiero (Gobierno)</h5>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('main.adjust_citizen_balance', user_id=citizen.id) }}" method="POST">
                            {{ adjust_balance_form.hidden_tag() }}
                            <div class="mb-3">
                                <label class="form-label">Operaci√≥n</label>
                                {{ adjust_balance_form.operation(class="form-select") }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cantidad</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ adjust_balance_form.amount(class="form-control", placeholder="0.00") }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Raz√≥n / Motivo</label>
                                {{ adjust_balance_form.reason(class="form-control", rows=2) }}
                            </div>
                            <button type="submit" class="btn btn-dark w-100">Aplicar Ajuste</button>
                        </form>
                    </div>
                </div>

                <!-- NUEVO: Panel de Administraci√≥n de Identidad (Solo Gobierno) -->
                <div class="card mb-4 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">Administraci√≥n de Identidad</h5>
                    </div>
                    <div class="card-body d-grid gap-2">
                        <button class="btn btn-outline-danger" onclick="openModal('editInfoModal')">
                            üìù Editar Nombre y DNI
                        </button>
                        <button class="btn btn-outline-danger" onclick="openModal('editPhotosModal')">
                            üì∑ Actualizar Fotos
                        </button>
                        
                        <form action="{{ url_for('main.unlink_discord', user_id=citizen.id) }}" method="POST" onsubmit="return confirm('¬øSeguro que quieres desvincular el Discord?');">
                            <button type="submit" class="btn btn-outline-dark w-100">
                                üîå Desvincular Discord
                            </button>
                        </form>

                        <form action="{{ url_for('main.clear_criminal_records', user_id=citizen.id) }}" method="POST" onsubmit="return confirm('¬øEST√ÅS SEGURO? Esto borrar√° TODOS los antecedentes penales de este usuario permanentemente.');">
                            <button type="submit" class="btn btn-dark w-100 fw-bold">
                                üóëÔ∏è BORRAR ANTECEDENTES
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}

                <!-- Antecedentes Penales -->
                <div class="section-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0 text-danger">Antecedentes Penales</h4>
                        {% if can_edit %}
                        <button class="btn btn-sm btn-danger" onclick="openModal('criminalModal')">+ Nuevo Registro</button>
                        {% endif %}
                    </div>
                    
                    {% if citizen.criminal_records %}
                        <div class="accordion" id="criminalAccordion">
                            {% for record in citizen.criminal_records %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ record.id }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ record.id }}">
                                        {{ record.date.strftime('%d/%m/%Y') }} - {{ record.crime }} (Oficial: {{ record.author.last_name }})
                                    </button>
                                </h2>
                                <div id="collapse{{ record.id }}" class="accordion-collapse collapse" data-bs-parent="#criminalAccordion">
                                    <div class="accordion-body">
                                        <p><strong>C√≥digo Penal:</strong> {{ record.penal_code }}</p>
                                        <p><strong>Informe:</strong> {{ record.report_text }}</p>
                                        <!-- Fotos si las hubiera -->
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-success">Este ciudadano no tiene antecedentes registrados.</div>
                    {% endif %}
                </div>

                <!-- Multas de Tr√°fico -->
                <div class="section-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0 text-warning">Multas de Tr√°fico</h4>
                        {% if can_edit %}
                        <button class="btn btn-sm btn-warning text-white" onclick="openModal('fineModal')">+ Nueva Multa</button>
                        {% endif %}
                    </div>
                    
                    {% if citizen.traffic_fines %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                        <th>Raz√≥n</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fine in citizen.traffic_fines %}
                                    <tr>
                                        <!-- CORRECCI√ìN: 'created_at' cambiado a 'date' seg√∫n el modelo TrafficFine -->
                                        <td>{{ fine.date.strftime('%d/%m') }}</td>
                                        <td>${{ fine.amount }}</td>
                                        <td>{{ fine.reason }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if fine.status == 'Pagada' else 'danger' }}">
                                                {{ fine.status }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">Sin multas registradas.</p>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>

    <!-- Modals -->
    {% if can_edit %}
    <!-- Modal Criminal Record -->
    <div id="criminalModal" class="modal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Antecedente Penal</h5>
                    <button type="button" class="btn-close" onclick="closeModal('criminalModal')"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('main.add_criminal_record', user_id=citizen.id) }}" method="POST" enctype="multipart/form-data">
                        {{ criminal_form.hidden_tag() }}
                        <div class="mb-3">
                            <label class="form-label">Fecha del Hecho</label>
                            {{ criminal_form.date(class="form-control", type="date") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Delito</label>
                            {{ criminal_form.crime(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">C√≥digo Penal</label>
                            {{ criminal_form.penal_code(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Informe</label>
                            {{ criminal_form.report_text(class="form-control", rows=3) }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fotos Sujeto (Opcional)</label>
                            {{ criminal_form.subject_photos(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fotos Evidencia (Opcional)</label>
                            {{ criminal_form.evidence_photos(class="form-control") }}
                        </div>
                        <button type="submit" class="btn btn-danger w-100">Guardar Antecedente</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Traffic Fine -->
    <div id="fineModal" class="modal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Imponer Multa</h5>
                    <button type="button" class="btn-close" onclick="closeModal('fineModal')"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('main.add_traffic_fine', user_id=citizen.id) }}" method="POST">
                        {{ fine_form.hidden_tag() }}
                        <div class="mb-3">
                            <label class="form-label">Monto</label>
                            {{ fine_form.amount(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Raz√≥n</label>
                            {{ fine_form.reason(class="form-control") }}
                        </div>
                        <button type="submit" class="btn btn-warning w-100">Imponer Multa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if can_adjust_balance %}
    <!-- Modal Editar Info -->
    <div id="editInfoModal" class="modal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Informaci√≥n Personal</h5>
                    <button type="button" class="btn-close" onclick="closeModal('editInfoModal')"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('main.edit_citizen_info', user_id=citizen.id) }}" method="POST">
                        {{ edit_info_form.hidden_tag() }}
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            {{ edit_info_form.first_name(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Apellido</label>
                            {{ edit_info_form.last_name(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">DNI</label>
                            {{ edit_info_form.dni(class="form-control") }}
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Fotos -->
    <div id="editPhotosModal" class="modal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Actualizar Fotos</h5>
                    <button type="button" class="btn-close" onclick="closeModal('editPhotosModal')"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('main.update_citizen_photos', user_id=citizen.id) }}" method="POST" enctype="multipart/form-data">
                        {{ edit_photos_form.hidden_tag() }}
                        <div class="mb-3">
                            <label class="form-label">Nueva Selfie</label>
                            {{ edit_photos_form.selfie(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nueva Foto DNI</label>
                            {{ edit_photos_form.dni_photo(class="form-control") }}
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Subir Fotos</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Agregamos el JS de Bootstrap para que funcionen los componentes interactivos como el acorde√≥n -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function openModal(id) {
            document.getElementById(id).style.display = "block";
            document.getElementById(id).classList.add('show');
        }
        function closeModal(id) {
            document.getElementById(id).style.display = "none";
            document.getElementById(id).classList.remove('show');
        }
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>
</html>
