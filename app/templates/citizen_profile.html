<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil Ciudadano: {{ citizen.first_name }} {{ citizen.last_name }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .profile-header {
            background: linear-gradient(135deg, #2c3e50, #4ca1af);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        .profile-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .section-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .dni-card {
            max-width: 300px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .map-preview {
            position: relative;
            width: 100%;
            border: 1px solid #ccc;
        }
        .map-marker-static {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid white;
        }
        .business-item { cursor: pointer; transition: background 0.2s; }
        .business-item:hover { background-color: #f1f1f1; }
    </style>
</head>
<body>

    <!-- Header / Navbar simple -->
    <nav class="navbar navbar-dark bg-dark mb-0">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.official_dashboard') }}">‚Üê Volver al Panel Oficial</a>
            <span class="navbar-text">
                Logueado como: {{ current_user.first_name }} {{ current_user.last_name }} ({{ current_user.department }})
            </span>
        </div>
    </nav>

    <!-- Profile Header -->
    <div class="profile-header text-center">
        <div class="container">
            <img src="{{ url_for('static', filename='img/' + citizen.selfie_filename) }}" alt="Foto Perfil" class="profile-img mb-3">
            <h1>{{ citizen.first_name }} {{ citizen.last_name }}</h1>
            <p class="lead">DNI: {{ citizen.dni }}</p>
            {% if citizen.discord_id %}
                <span class="badge bg-primary">Discord Vinculado</span>
            {% else %}
                <span class="badge bg-secondary">Sin Discord</span>
            {% endif %}
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- Left Column: Personal Info & Bank -->
            <div class="col-md-4">
                <div class="section-card">
                    <h4>Datos Personales</h4>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Nombre:</strong> {{ citizen.first_name }}</li>
                        <li class="list-group-item"><strong>Apellido:</strong> {{ citizen.last_name }}</li>
                        <li class="list-group-item"><strong>DNI:</strong> {{ citizen.dni }}</li>
                        <li class="list-group-item"><strong>Estado:</strong> Ciudadano</li>
                    </ul>
                    <div class="mt-3 text-center">
                        <label class="form-label text-muted">Foto DNI:</label><br>
                        <img src="{{ url_for('static', filename='img/' + citizen.dni_photo_filename) }}" class="dni-card img-fluid" alt="DNI Foto">
                    </div>
                </div>

                <!-- Licencias y Negocios -->
                <div class="section-card">
                    <h4>Licencias Personales</h4>
                    <ul class="list-group mb-3">
                    {% for lic in citizen.licenses %}
                        {% if lic.business_id is none %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ lic.type }}
                                <span class="badge bg-{{ 'success' if lic.status == 'Activa' else 'danger' }}">{{ lic.status }}</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    </ul>

                    <h4>Negocios Registrados</h4>
                    {% if citizen.businesses.count() > 0 %}
                        <div class="list-group">
                        {% for biz in citizen.businesses %}
                            <div class="list-group-item business-item" onclick="showBusinessModal('{{ biz.name }}', '{{ biz.type }}', '{{ biz.location_x }}', '{{ biz.location_y }}', '{{ url_for('static', filename='img/' + (biz.photo_filename or 'default.jpg')) }}', [{% for l in biz.licenses.all() %}'{{ l.type }}',{% endfor %}])">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ biz.name }}</h5>
                                    <small>{{ biz.type }}</small>
                                </div>
                                <small class="text-muted">Click para ver detalles</small>
                            </div>
                        {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No posee negocios registrados.</p>
                    {% endif %}
                </div>

                <!-- Notas / Comentarios -->
                <div class="section-card">
                    <h4>Notas Oficiales</h4>
                    {% if citizen.comments %}
                        <div style="max-height: 200px; overflow-y: auto;" class="mb-3">
                            {% for comment in citizen.comments %}
                                <div class="border-bottom pb-2 mb-2">
                                    <small class="text-muted">{{ comment.timestamp.strftime('%d/%m/%Y') }} - {{ comment.author.first_name }} {{ comment.author.last_name }} ({{ comment.author.department }})</small>
                                    <p class="mb-0">{{ comment.content }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted small">Sin comentarios.</p>
                    {% endif %}

                    {% if can_edit %}
                    <form action="{{ url_for('main.add_comment', user_id=citizen.id) }}" method="POST">
                        {{ comment_form.hidden_tag() }}
                        <div class="input-group">
                            {{ comment_form.content(class="form-control", placeholder="Agregar nota...", rows=1) }}
                            <button class="btn btn-outline-secondary" type="submit">Add</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>

            <!-- Right Column: Actions & Records -->
            <div class="col-md-8">
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category if category != 'message' else 'info' }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- NUEVO: Panel de Administraci√≥n de Identidad (Solo Gobierno) -->
                {% if current_user.department == 'Gobierno' %}
                <div class="card mb-4 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">Administraci√≥n de Identidad</h5>
                    </div>
                    <div class="card-body d-grid gap-2">
                        <button class="btn btn-outline-danger" onclick="openModal('editInfoModal')">
                            üìù Editar Nombre y DNI
                        </button>
                        <button class="btn btn-outline-danger" onclick="openModal('editPhotosModal')">
                            üì∑ Actualizar Fotos
                        </button>
                        
                        <form action="{{ url_for('main.unlink_discord', user_id=citizen.id) }}" method="POST" onsubmit="return confirm('¬øSeguro que quieres desvincular el Discord?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-outline-dark w-100">
                                üîå Desvincular Discord
                            </button>
                        </form>

                        <form action="{{ url_for('main.clear_criminal_records', user_id=citizen.id) }}" method="POST" onsubmit="return confirm('¬øEST√ÅS SEGURO? Esto borrar√° TODOS los antecedentes penales de este usuario permanentemente.');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-dark w-100 fw-bold">
                                üóëÔ∏è BORRAR ANTECEDENTES
                            </button>
                        </form>

                        <!-- CAMBIO: Bot√≥n para cambiar contrase√±a en lugar de Reset -->
                        <button class="btn btn-warning w-100 fw-bold" onclick="openModal('changePasswordModal')">
                            üîë CAMBIAR CONTRASE√ëA
                        </button>

                        <form action="{{ url_for('main.delete_citizen_account', user_id=citizen.id) }}" method="POST" onsubmit="return confirm('‚ö†Ô∏è PELIGRO: ¬øEst√°s seguro de ELIMINAR COMPLETAMENTE a este usuario? Esta acci√≥n es IRREVERSIBLE.');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-outline-danger w-100 fw-bold mt-2" style="border: 2px solid red;">
                                üíÄ ELIMINAR USUARIO
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}

                <!-- Antecedentes Penales -->
                <div class="section-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0 text-danger">Antecedentes Penales</h4>
                        {% if can_edit %}
                        <button class="btn btn-sm btn-danger" onclick="openModal('criminalModal')">+ Nuevo Registro</button>
                        {% endif %}
                    </div>
                    
                    {% if citizen.criminal_records %}
                        <div class="accordion" id="criminalAccordion">
                            {% for record in citizen.criminal_records %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ record.id }}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ record.id }}">
                                        {{ record.date.strftime('%d/%m/%Y') }} - {{ record.crime }} (Oficial: {{ record.author.last_name }})
                                    </button>
                                </h2>
                                <div id="collapse{{ record.id }}" class="accordion-collapse collapse" data-bs-parent="#criminalAccordion">
                                    <div class="accordion-body">
                                        <p><strong>C√≥digo Penal:</strong> {{ record.penal_code }}</p>
                                        <p><strong>Informe:</strong> {{ record.report_text }}</p>
                                        <!-- Fotos si las hubiera -->
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-success">Este ciudadano no tiene antecedentes registrados.</div>
                    {% endif %}
                </div>

                <!-- Multas de Tr√°fico -->
                <div class="section-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0 text-warning">Multas de Tr√°fico</h4>
                        {% if can_edit %}
                        <button class="btn btn-sm btn-warning text-white" onclick="openModal('fineModal')">+ Nueva Multa</button>
                        {% endif %}
                    </div>
                    
                    {% if citizen.traffic_fines %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Raz√≥n</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fine in citizen.traffic_fines %}
                                    <tr>
                                        <td>{{ fine.date.strftime('%d/%m') }}</td>
                                        <td>{{ fine.reason }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if fine.status == 'Pagada' else 'danger' }}">
                                                {{ fine.status }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">Sin multas registradas.</p>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL VISTA DETALLADA DE NEGOCIO -->
    <div class="modal fade" id="businessDetailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bizTitle">Detalles del Negocio</h5>
                    <button type="button" class="btn-close" onclick="closeModal('businessDetailModal')"></button>
                </div>
                <div class="modal-body">
                    <h6 id="bizType" class="text-muted mb-3"></h6>
                    <img id="bizPhoto" src="" class="img-fluid mb-3 rounded" alt="Foto Local">
                    
                    <h6>Ubicaci√≥n:</h6>
                    <div class="map-preview mb-3">
                        <img src="{{ url_for('static', filename='img/mi_mapa.png') }}" class="img-fluid">
                        <div id="bizMarker" class="map-marker-static"></div>
                    </div>

                    <h6>Licencias Activas:</h6>
                    <ul id="bizLicenses" class="list-group"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals Existentes (Criminal, Fine, Edit, etc...) -->
    <!-- ... (El c√≥digo de los otros modales se mantiene igual, solo aseg√∫rate de incluir el JS de abajo) ... -->
    {% if can_edit %}
    <div id="criminalModal" class="modal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <!-- ... (Contenido del modal CriminalRecordForm) ... -->
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Antecedente</h5>
                    <button type="button" class="btn-close" onclick="closeModal('criminalModal')"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('main.add_criminal_record', user_id=citizen.id) }}" method="POST" enctype="multipart/form-data">
                        {{ criminal_form.hidden_tag() }}
                        <!-- Campos del formulario -->
                        <div class="mb-3">{{ criminal_form.date.label }} {{ criminal_form.date(class="form-control", type="date") }}</div>
                        <div class="mb-3">{{ criminal_form.crime.label }} {{ criminal_form.crime(class="form-control") }}</div>
                        <div class="mb-3">{{ criminal_form.penal_code.label }} {{ criminal_form.penal_code(class="form-control") }}</div>
                        <div class="mb-3">{{ criminal_form.report_text.label }} {{ criminal_form.report_text(class="form-control", rows=3) }}</div>
                        <div class="mb-3">{{ criminal_form.subject_photos.label }} {{ criminal_form.subject_photos(class="form-control") }}</div>
                        <div class="mb-3">{{ criminal_form.evidence_photos.label }} {{ criminal_form.evidence_photos(class="form-control") }}</div>
                        <button type="submit" class="btn btn-danger w-100">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="fineModal" class="modal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <!-- ... (Contenido del modal TrafficFineForm) ... -->
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Imponer Multa</h5>
                    <button type="button" class="btn-close" onclick="closeModal('fineModal')"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('main.add_traffic_fine', user_id=citizen.id) }}" method="POST">
                        {{ fine_form.hidden_tag() }}
                        <div class="mb-3">{{ fine_form.reason.label }} {{ fine_form.reason(class="form-control") }}</div>
                        <button type="submit" class="btn btn-warning w-100">Imponer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if current_user.department == 'Gobierno' %}
    <div id="editInfoModal" class="modal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
       <!-- ... Contenido EditInfo ... -->
       <div class="modal-dialog"><div class="modal-content"><div class="modal-body">
           <form action="{{ url_for('main.edit_citizen_info', user_id=citizen.id) }}" method="POST">
               {{ edit_info_form.hidden_tag() }}
               {{ edit_info_form.first_name(class="form-control mb-2") }}
               {{ edit_info_form.last_name(class="form-control mb-2") }}
               {{ edit_info_form.dni(class="form-control mb-2") }}
               <button class="btn btn-primary w-100">Guardar</button>
           </form>
       </div></div></div>
    </div>
    <div id="editPhotosModal" class="modal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
       <!-- ... Contenido EditPhotos ... -->
       <div class="modal-dialog"><div class="modal-content"><div class="modal-body">
           <form action="{{ url_for('main.update_citizen_photos', user_id=citizen.id) }}" method="POST" enctype="multipart/form-data">
               {{ edit_photos_form.hidden_tag() }}
               {{ edit_photos_form.selfie(class="form-control mb-2") }}
               {{ edit_photos_form.dni_photo(class="form-control mb-2") }}
               <button class="btn btn-primary w-100">Subir</button>
           </form>
       </div></div></div>
    </div>

    <!-- NUEVO: Modal Cambiar Contrase√±a -->
    <div id="changePasswordModal" class="modal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
       <div class="modal-dialog"><div class="modal-content">
           <div class="modal-header">
               <h5 class="modal-title">Cambiar Contrase√±a</h5>
               <button type="button" class="btn-close" onclick="closeModal('changePasswordModal')"></button>
           </div>
           <div class="modal-body">
               <form action="{{ url_for('main.change_citizen_password', user_id=citizen.id) }}" method="POST">
                   {{ change_password_form.hidden_tag() }}
                   <div class="mb-3">
                       <label class="form-label">Nueva Contrase√±a</label>
                       {{ change_password_form.new_password(class="form-control") }}
                   </div>
                   <button class="btn btn-warning w-100">Establecer</button>
               </form>
           </div>
       </div></div>
    </div>
    {% endif %}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function openModal(id) {
            var el = document.getElementById(id);
            if(el) {
                el.style.display = "block";
                el.classList.add('show');
            }
        }
        function closeModal(id) {
            var el = document.getElementById(id);
            if(el) {
                el.style.display = "none";
                el.classList.remove('show');
            }
        }

        // L√≥gica para mostrar detalles del negocio
        function showBusinessModal(name, type, x, y, photoUrl, licenses) {
            document.getElementById('bizTitle').innerText = name;
            document.getElementById('bizType').innerText = type;
            document.getElementById('bizPhoto').src = photoUrl;
            
            // Posicionar marcador en el mapa est√°tico
            var marker = document.getElementById('bizMarker');
            marker.style.left = x + '%';
            marker.style.top = y + '%';

            // Listar licencias
            var list = document.getElementById('bizLicenses');
            list.innerHTML = '';
            licenses.forEach(function(lic) {
                var li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerText = lic;
                list.appendChild(li);
            });

            var myModal = new bootstrap.Modal(document.getElementById('businessDetailModal'));
            myModal.show();
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
                event.target.classList.remove('show');
            }
        }
    </script>
</body>
</html>
