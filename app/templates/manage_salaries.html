<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Salarios y Personal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .member-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid #dee2e6;
            background-color: #f8f9fa; /* Fondo gris claro mientras carga */
        }
        .salary-badge {
            font-size: 1.1em;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <a href="{{ url_for('main.official_dashboard') }}" class="btn btn-outline-secondary mb-4">← Volver al Panel</a>
        
        <h2 class="mb-4">Gestión de Personal: {{ current_user.department }}</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'message' else 'info' }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card shadow-sm">
            <div class="card-body">
                {% if members %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Funcionario</th>
                                <th>Rango</th>
                                <th>Sueldo Actual</th>
                                <th>Asignar Nuevo Sueldo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in members %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <!-- ESTRATEGIA DE BÚSQUEDA DE IMAGEN: img/ -> uploads/ -> Avatar -->
                                        <!-- Se intenta primero img/, si falla el script prueba uploads/, si falla usa UI Avatars -->
                                        <img src="{{ url_for('static', filename='img/' + (member.selfie_filename or 'default.jpg')) }}" 
                                             data-backup-src="{{ url_for('static', filename='uploads/' + (member.selfie_filename or 'default.jpg')) }}"
                                             class="member-img" 
                                             alt="Foto de {{ member.first_name }}"
                                             onerror="handleImageError(this, '{{ member.first_name }}', '{{ member.last_name }}')">
                                        <div>
                                            <div class="fw-bold">{{ member.first_name }} {{ member.last_name }}</div>
                                            <small class="text-muted">Placa: {{ member.badge_id }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-secondary">{{ member.official_rank }}</span></td>
                                <td>
                                    <span class="badge bg-success salary-badge">${{ "{:,.2f}".format(member.salary) }}</span>
                                </td>
                                <td>
                                    <form action="{{ url_for('main.update_salary', user_id=member.id) }}" method="POST" class="d-flex gap-2">
                                        {{ salary_form.hidden_tag() }}
                                        <div class="input-group input-group-sm" style="max-width: 150px;">
                                            <span class="input-group-text">$</span>
                                            {{ salary_form.salary(class="form-control", placeholder="0", value=member.salary) }}
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm">Guardar</button>
                                    </form>
                                </td>
                                <td>
                                    {% if member.id != current_user.id %}
                                    <form action="{{ url_for('main.kick_member', user_id=member.id) }}" method="POST" onsubmit="return confirm('¿Estás SEGURO de expulsar a {{ member.first_name }}? Esta acción revocará su acceso y placa.');">
                                        <button type="submit" class="btn btn-outline-danger btn-sm">Expulsar</button>
                                    </form>
                                    {% else %}
                                    <span class="text-muted small">Tú</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p class="text-center text-muted py-4">No hay miembros activos en tu departamento.</p>
                {% endif %}
            </div>
        </div>

        <div class="mt-4 text-end">
            <form action="{{ url_for('main.submit_payroll') }}" method="POST">
                <button type="submit" class="btn btn-success btn-lg">Enviar Nómina para Aprobación</button>
            </form>
            <small class="text-muted d-block mt-2">Esto enviará una solicitud al Gobierno con la suma total de los sueldos actuales.</small>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Función para recuperar imágenes perdidas
        function handleImageError(img, firstName, lastName) {
            // Verificar si ya intentamos cargar el backup (la carpeta uploads)
            if (!img.dataset.triedBackup) {
                // Marcamos que ya lo vamos a intentar para no entrar en bucle
                img.dataset.triedBackup = true; 
                
                // Cambiamos la fuente a la ruta de respaldo (uploads/)
                img.src = img.getAttribute('data-backup-src');
            } else {
                // Si falla también el backup, entonces sí usamos el avatar generado
                img.onerror = null; // Prevenir loop infinito
                img.src = `https://ui-avatars.com/api/?name=${firstName}+${lastName}&background=random&color=fff&size=128`;
            }
        }
    </script>
</body>
</html>
